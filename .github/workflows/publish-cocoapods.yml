name: Publish to CocoaPods

on:
  # Temporarily disabled - enable when iOS publishing is ready
  # push:
  #   tags:
  #     - '*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish'
        required: true
        default: '2.0.15'

jobs:
  publish-cocoapods:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
          
      - name: Install CocoaPods
        run: |
          sudo gem install cocoapods
          pod setup
          
      - name: Extract version from tag or input
        id: extract_version
        run: |
          if [ "${{ github.event_name }}" == "push" ] && [ "${{ startsWith(github.ref, 'refs/tags/') }}" == "true" ]; then
            TAG_NAME=${{ github.ref_name }}
            echo "Using version from tag: $TAG_NAME"
            # Extract version number (remove 'v' prefix if present)
            if [[ $TAG_NAME =~ ^v[0-9] ]]; then
              VERSION=${TAG_NAME#v}
            else
              VERSION=$TAG_NAME
            fi
          elif [ "${{ github.event.inputs.version }}" != "" ]; then
            VERSION=${{ github.event.inputs.version }}
            echo "Using manual version: $VERSION"
          else
            VERSION="2.0.15"
            echo "Using default version: $VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Final version: $VERSION"
          
      - name: Setup Node.js for version sync
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Sync versions from central config
        run: |
          echo "ðŸ”„ Syncing versions from version.json..."
          node scripts/sync-versions.js
          
      - name: Update podspec version
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"
          echo "Updating Gamepulse.podspec with version: $VERSION"
          cd research/ios
          
          # Update version in podspec
          sed -i '' "s/spec.version.*=.*/spec.version = \"$VERSION\"/" Gamepulse.podspec
          
          echo "Updated podspec:"
          grep "spec.version" Gamepulse.podspec
          
      - name: Validate podspec
        run: |
          cd research/ios
          echo "Validating podspec..."
          pod spec lint Gamepulse.podspec --quick --skip-import-validation --skip-tests --allow-warnings
          
      - name: Setup CocoaPods authentication
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
        run: |
          if [ -z "$COCOAPODS_TRUNK_TOKEN" ]; then
            echo "âŒ COCOAPODS_TRUNK_TOKEN secret not found"
            echo ""
            echo "ðŸ“‹ CocoaPods Setup Instructions:"
            echo "1. Register your CocoaPods account:"
            echo "   pod trunk register your-email@domain.com 'Gamepulse'"
            echo "2. Check your email and click the verification link"
            echo "3. Get your session token:"
            echo "   cat ~/.netrc | grep cocoapods"
            echo "4. Add the token as COCOAPODS_TRUNK_TOKEN in GitHub repository secrets"
            echo "5. Re-run this workflow"
            exit 1
          else
            echo "âœ… CocoaPods authentication configured"
          fi
          
      - name: Publish to CocoaPods
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
        run: |
          cd research/ios
          echo "Publishing Gamepulse v${{ steps.extract_version.outputs.version }} to CocoaPods..."
          
          # Final validation
          pod spec lint Gamepulse.podspec --quick --skip-import-validation --skip-tests --allow-warnings
          
          # Publish to CocoaPods Trunk
          pod trunk push Gamepulse.podspec --skip-import-validation --skip-tests --allow-warnings
          
          echo "âœ… Successfully published Gamepulse v${{ steps.extract_version.outputs.version }} to CocoaPods!"
          
      - name: Create publication summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸŽ‰ CocoaPods Publication Successful
          
          **Package**: Gamepulse iOS SDK  
          **Version**: ${{ steps.extract_version.outputs.version }}  
          **Platform**: iOS 12.0+  
          **Language**: Swift 5.0  
          
          ## ðŸ“± Installation for Developers
          \`\`\`ruby
          # Add to your iOS project's Podfile
          pod 'Gamepulse', '~> ${{ steps.extract_version.outputs.version }}'
          \`\`\`
          
          Then run:
          \`\`\`bash
          pod install
          \`\`\`
          
          ## ðŸ”— Resources
          - [CocoaPods Page](https://cocoapods.org/pods/Gamepulse)
          - [iOS Documentation](https://github.com/gamepulse/gamepulse-sdk/blob/main/research/README.md)
          - [Source Code](https://github.com/gamepulse/gamepulse-sdk/tree/main/research/ios)
          - [All Platforms](https://github.com/gamepulse/gamepulse-sdk#quick-start)
          EOF